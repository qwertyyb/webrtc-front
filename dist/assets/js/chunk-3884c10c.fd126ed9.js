(window["webpackJsonp"]=window["webpackJsonp"]||[]).push([["chunk-3884c10c"],{"10f1":function(e,t,n){"use strict";n.r(t);var o=function(){var e=this,t=e.$createElement,o=e._self._c||t;return o("div",{staticClass:"mx-4"},[o("el-row",{attrs:{type:"flex",justify:"center",align:"middle"}},[o("el-col",{staticClass:"text-right",attrs:{span:8}},[e._v("\n      请输入对方的用户名：\n    ")]),o("el-col",{attrs:{span:8}},[o("el-input",{attrs:{size:"small"},model:{value:e.friend.nickname,callback:function(t){e.$set(e.friend,"nickname",t)},expression:"friend.nickname"}})],1),o("el-col",{staticClass:"ml-2",attrs:{span:8}},[o("el-button",{attrs:{size:"small",type:"primary",disabled:"free"!=e.status},on:{click:e.askACall}},[e._v(e._s("free"==e.status?"开始呼叫":"正在呼叫..."))]),o("el-button",{attrs:{size:"small",type:"danger",disabled:"free"==e.status},on:{click:e.stopACall}},[e._v("挂断")])],1)],1),o("el-row",{attrs:{gutter:20,hidden:"free"===e.status}},[o("el-col",{attrs:{span:12}},[o("video",{ref:"self-video",staticClass:"w-full m-2",attrs:{src:"",id:"self-video",autoplay:"",poster:n("b8b5")}}),o("p",{staticClass:"text-center"},[e._v("我")])]),o("el-col",{attrs:{span:12}},[o("video",{ref:"friend-video",staticClass:"m-2 friend-video",attrs:{src:"",autoplay:"",poster:n("b8b5")}}),o("p",{staticClass:"text-center"},[e._v(e._s(e.friend.nickname))])])],1)],1)},i=[],s=n("5c96"),c=n("d5db"),a=n("4777"),r=n("6c23"),l=null,d=null,f={name:"page-call",data:function(){return{friend:{nickname:""},status:"free"}},created:function(){window.addEventListener("unload",this.stopACall)},mounted:function(){console.log(this)},beforeDestroy:function(){this.stopACall(),window.removeEventListener("unload",this.stopACall)},methods:{askACall:function(){var e=this.friend.nickname;e&&e.trim()?(this.stopACall(),l=new c["a"](this.$refs["self-video"]),l.on("error",this.onCallerror),l.start(e.trim()),this.status="calling",this.bindEvents()):this.$message.warning("请输入对方用户名")},stopACall:function(){this.offEvents(),l&&l.stop(),d&&d.stop(),this.status="free"},bindEvents:function(){var e=Object(r["a"])();e.once("callaccepted",this.onCallaccepted),e.once("callrejected",this.onCallrejected),e.on("callerror",this.onCallerror)},offEvents:function(){var e=Object(r["a"])();e.off("callaccepted",this.onCallaccepted),e.off("callrejected",this.onCallrejected),e.off("callerror",this.onCallerror)},onCallrejected:function(e){var t=e.to;this.stopACall(),this.status="free",s["Notification"].warning({title:"呼叫已被".concat(t.nickname,"拒绝")})},onCallaccepted:function(e){var t=this,n=e.to,o=e.linkId;console.log("呼叫已被".concat(n.nickname,"接听")),s["Notification"].success({title:"呼叫已被".concat(n.nickname,"接听"),message:"正在建立连接..."}),d=new a["a"](this.$refs["friend-video"],o),d.on("presentorgone",function(e){t.stopACall()}),d.start()},onCallerror:function(e){var t=e.message;this.stopACall(),s["Notification"].error({title:t}),this.status="free"}}},u=f,v=n("2877"),h=Object(v["a"])(u,o,i,!1,null,null,null);t["default"]=h.exports},4777:function(e,t,n){"use strict";n("7f7f");var o=n("a4bb"),i=n.n(o),s=(n("6762"),n("2fdb"),n("f499")),c=n.n(s),a=n("795b"),r=n.n(a),l=n("d225"),d=n("b0b4"),f=n("bd86"),u=n("a825"),v=n("d519"),h=n.n(v),p=n("8055"),b=n.n(p),m=n("c0d6"),k=function(){function e(t,n){var o=this;Object(l["a"])(this,e),Object(f["a"])(this,"socket",null),Object(f["a"])(this,"videoDom",null),Object(f["a"])(this,"webRtcPeer",null),Object(f["a"])(this,"events",{start:[],stop:[],presentorgone:[]}),Object(f["a"])(this,"_onVideoCanplay",function(e){o.emit("start")}),Object(f["a"])(this,"bindEvent",function(){var e=o.socket,t=o.webRtcPeer;e.on("startResponse",function(e){var n=e.sdpAnswer;console.log("SDP answer received from server. Processing ..."),t.processAnswer(n)}),e.on("iceCandidate",function(e){var n=e.candidate;console.log("iceCandidate",n),t.addIceCandidate(n)}),e.on("presentorgone",function(e){o.videoDom.pause(),o.videoDom.srcObject=null,o.videoDom.load(),o.emit("presentorgone"),o.socket.close(),o.emit("stop")}),console.log(t)}),Object(f["a"])(this,"start",function(){var e={remoteVideo:o.videoDom,onicecandidate:o.onIceCandidate,configuration:{iceServers:u["a"]}};return new r.a(function(t,n){o.webRtcPeer=h.a.WebRtcPeer.WebRtcPeerRecvonly(e,function(e){if(e)return n(e);t()})}).then(function(e){return o.bindEvent(),new r.a(function(e,t){return o.webRtcPeer.generateOffer(function(n,o){if(n)return t(n);e(o)})})}).then(function(e){console.info("Invoking SDP offer callback function "+location.host),o.socket.emit("createViewer",{sdpOffer:e})})}),Object(f["a"])(this,"stop",function(){console.log("Stopping video call ..."),o.webRtcPeer&&(o.webRtcPeer.dispose(),console.log("dispose"),o.webRtcPeer=null),o.socket.emit("stop")}),Object(f["a"])(this,"onIceCandidate",function(e){console.log("Local candidate"+c()(e)),o.socket.emit("onIceCandidate",{candidate:e})}),console.log(t),this.socket=b()({path:"/socket.io/webrtc",query:{token:m["a"].state.token,presentorId:n},reconnection:!1}),this.socket.on("error",function(e){o.emit("error",e)}),this.socket.on("connect_error",function(e){console.log("error"),o.emit("error",e)}),this.videoDom=t,t.addEventListener("canplay",this._onVideoCanplay)}return Object(d["a"])(e,[{key:"emit",value:function(e){for(var t=arguments.length,n=new Array(t>1?t-1:0),o=1;o<t;o++)n[o-1]=arguments[o];if(i()(this.events).includes(e)){var s=this.events[e];return s.map(function(e){return e.apply(void 0,n)})}}},{key:"on",value:function(e,t){if(i()(this.events).includes(e)){var n=this.events[e];n.includes(t)||n.push(t)}}}]),e}();t["a"]=k},d5db:function(e,t,n){"use strict";n("7f7f");var o=n("a4bb"),i=n.n(o),s=(n("6762"),n("2fdb"),n("f499")),c=n.n(s),a=n("795b"),r=n.n(a),l=n("d225"),d=n("b0b4"),f=n("bd86"),u=n("a825"),v=n("d519"),h=n.n(v),p=n("6c23"),b=function(){function e(t){var n=this;Object(l["a"])(this,e),Object(f["a"])(this,"socket",null),Object(f["a"])(this,"localVideo",null),Object(f["a"])(this,"webRtcPeer",null),Object(f["a"])(this,"events",{start:[],stop:[],error:[],callaccepted:[],callrejected:[],callerror:[]}),Object(f["a"])(this,"_onVideoCanplay",function(e){console.log("onvideocanplay"),n.emit("start")}),Object(f["a"])(this,"bindEvent",function(){var e=n.socket,t=n.webRtcPeer;e.on("startResponse",function(e){var n=e.sdpAnswer;console.log("SDP answer received from server. Processing ..."),t.processAnswer(n)}),e.on("iceCandidate",function(e){var n=e.candidate;t.addIceCandidate(n)})}),Object(f["a"])(this,"start",function(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:null,t={remoteVideo:n.localVideo,mediaConstraints:{video:{width:640,height:480},audio:!0},onicecandidate:n.onIceCandidate,configuration:{iceServers:u["a"]}};return new r.a(function(e,o){n.webRtcPeer=h.a.WebRtcPeer.WebRtcPeerSendrecv(t,function(t){if(t)return o(t);e()})}).then(function(e){return n.bindEvent(),new r.a(function(e,t){return n.webRtcPeer.generateOffer(function(n,o){if(n)return t(n);e(o)})})}).then(function(t){console.info("Invoking SDP offer callback function "+location.host),n.socket.emit("createPresentor",{sdpOffer:t,invite:e})})}),Object(f["a"])(this,"stop",function(){console.log("Stopping video call ..."),n.webRtcPeer&&(n.webRtcPeer.dispose(),n.webRtcPeer=null),n.localVideo.removeEventListener("canplay",n._onVideoCanplay),n.socket.emit("stop"),n.socket.close(),n.emit("stop")}),Object(f["a"])(this,"onIceCandidate",function(e){console.log("Local candidate"+c()(e)),n.socket.emit("onIceCandidate",{candidate:e})}),this.socket=Object(p["b"])(),console.log(this.socket),this.socket.on("error",function(e){n.emit("error",e)}),this.socket.on("connect_error",function(e){n.emit("error",e)}),this.socket.on("callaccepted",function(e){n.emit("callaccepted",e)}),this.socket.on("callrejected",function(e){n.emit("callrejected",e)}),this.socket.on("callerror",function(e){n.emit("callerror",e)}),this.localVideo=t,t.addEventListener("canplay",this._onVideoCanplay)}return Object(d["a"])(e,[{key:"emit",value:function(e){for(var t=arguments.length,n=new Array(t>1?t-1:0),o=1;o<t;o++)n[o-1]=arguments[o];if(console.log(e,this.events),i()(this.events).includes(e)){var s=this.events[e];return s.map(function(e){return e.apply(void 0,n)})}}},{key:"on",value:function(e,t){if(i()(this.events).includes(e)){var n=this.events[e];if(!n.includes(t))return n.push(t),this}}}]),e}();t["a"]=b}}]);
//# sourceMappingURL=chunk-3884c10c.fd126ed9.js.map